{#
 Copyright (c) 2012 The Pycroft Authors. See the AUTHORS file.
 This file is part of the Pycroft project and licensed under the terms of
 the Apache License, Version 2.0. See the LICENSE file for details.
#}
{% extends "user/base.html" %}
{% import "macros/forms.html" as forms %}

{% block basecontent %}

    <div class="subnav subnav-fixed">
        <ul class="nav nav-pills">
            <li><a href="#basedata">Basisdaten</a></li>
            <li><a href="#traffic">Traffic</a></li>
            <li><a href="#hosts">Hosts</a></li>
            <li><a href="#logs">Logeinträge</a></li>
            <li><a href="#finance">Kontoeinträge</a></li>
            <li><a href="#groups">Gruppen</a></li>
        </ul>
    </div>


    {# Stammdaten #}
    <section id="basedata">
        <div class="head">Basisdaten</div>
        <div class="body">
            <div class="row">
                <div class="span3">ID:</div>
                <div class="span7">{{ user.id }}</div>
            </div>

            <div class="row">
                <div class="span3">Name:</div>
                <div class="span7">{{ user.name }}</div>
            </div>

            <div class="row">
                <div class="span3">Login:</div>
                <div class="span7">{{ user.login }}</div>
            </div>

            <div class="row">
                <div class="span3">Erstellungsdatum:</div>
                <div class="span7">{{ user.registration_date.
                            strftime("%d.%m.%Y %H:%M Uhr") }}</div>
            </div>

            <div class="row">
                <div class="span3">Raum:</div>
                <div class="span7"><a href="{{ url_for("dormitories.room_show",
            room_id = user.room_id) }}">{{ room.dormitory.short_name }}
                    {{ room.level }}-{{ room.number }}</a></div>
            </div>

            <div class="row">
                <div class="span3">Status:</div>
                <div class="span7">Freigeschalten</div>
            </div>
        </div>
    </section>


    {# Traffic #}
    <section id="traffic">
        <div class="head">Traffic</div>
        <div class="body" id="trafficchart">
        </div>
    </section>


    {# Hosts-Tabelle #}
    <section id="hosts">
        <div class="head">Hosts</div>
        <div class="body">
            {% if user.hosts %}
                {% for host in user.hosts %}
                    <div class="row">
                        <div class="span3">Hostname:
                            {{ host.hostname }}</div>
                        <div class="span7">
                            {% if host.net_devices %}
                                {% for netdevice in host.net_devices %}
                                    <div>
                                        Ethernet-Adresse:
                                        {{ netdevice.mac }}</div>
                                    <div>IPv4-Adresse:
                                        {{ netdevice.ipv4 }}</div>
                                    <div>IPv6-Adresse:
                                        {{ netdevice.ipv6 }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                Nutzer hat keine Hosts.
            {% endif %}
        </div>
    </section>


    {# Logeintrage des Nutzers #}
    <section id="logs">
        <div class="head">Logeinträge</div>
        <div class="body">
            <div class="row">
                {% if user_logs %}
                    <div class="row span10">
                        <dl>
                            {% for entry in user_logs %}
                                <dt>{{ entry.author.name }} (<a
                                        href="{{ url_for(".user_show",
                            user_id = entry.author.id) }}"
                                        >{{ entry.author.login }}</a>)
                                    am
                                    {{ entry.timestamp.strftime(
                                "%d.%m. um %H:%M Uhr") }}</dt>
                                <dd>{{ entry.message }}</dd>
                            {% endfor %}
                        </dl>
                    </div>
                {% else %}
                    <div class="row span10">Nutzer hat keine Einträge.
                    </div>
                {% endif %}
            </div>
            <div class="row">
                <div class="row span8">
                    <form method="POST" action=""
                          class="form-horizontal">
                        {{ form.hidden_tag() }}
                        {% for field in form %}
                            {% if field.type not in ["HiddenField",
                                            "CSRFTokenField"] %}
                                {{ field(placeholder='Nachricht',
                                                    class='span6') }}
                            {% endif %}
                        {% endfor %}
                        <button type="submit" class="btn
                                    btn-primary">Absenden
                        </button>
                    </form>

                    {# {{ forms.simple_form(form, '',
                                                url_for('.create')) }} #}
                </div>
            </div>
        </div>
    </section>


    {# Kontostand des Nutzers #}
    <section id="finance">
        <div class="head">Kontoeinträge</div>
        <div class="body">
            Not implemented yet.
        </div>
    </section>


    {# Gruppen des Nutzers #}
    <section id="groups">
        <div class="head">Gruppen</div>
        <div class="body">
            <table class="table table-condensed">
                <thead>
                <tr>
                    <th>Gruppe</th>
                    <th>Begin</th>
                    <th>Ende</th>
                </tr>
                </thead>
                <tbody>
                {% for membership in memberships %}
                    <tr>
                        <td>{{ membership.group.name }}</td>
                        <td>{{ membership.start_date.strftime("%d.%m.%Y") }}</td>
                        <td>{{ membership.end_date.strftime("%d.%m.%Y") }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            <a href="{{ url_for(".add_group_membership", user_id=user.id) }}">einer Gruppe hinzufügen</a>
        </div>
    </section>
{% endblock %}


{% block page_script %}
    <script type="text/javascript" src="{{ url_for("static", filename="highcharts/highcharts.js") }}"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var trafficchart = new Highcharts.Chart({
                                                        chart:{
                                                            renderTo:'trafficchart',
                                                            type:'column',
                                                            width: 600,
                                                            height: 250,
                                                            animation: false
                                                        },
                                                        title: {
                                                            text: null
                                                        },
                                                        plotOptions: {
                                                            series: { animation: false },
                                                            column: { stacking: 'normal' }
                                                        },
                                                        legend: {
                                                            enabled: false
                                                        },
                                                        tooltip: {
                                                            enabled: true,
                                                            formatter: function() {
                                                                var tooltip = '<b>'+ this.x +'</b>';
                                                                $.each(this.points, function(i, point) {
                                                                    tooltip += '<br />'+ point.series.name +': '+ point.y +'%';
                                                                });
                                                                return tooltip;
                                                            },
                                                            shared: true
                                                        },
                                                        xAxis:{
                                                            categories:['Montag', 'Dienstag', 'Mittwoch',
                                                                'Donnerstag', 'Freitag', 'Samstag', 'Sonntag']
                                                        },
                                                        yAxis: {
                                                            title: { text: null }
                                                        },
                                                        series:
                                                                [{ name: 'Input', data: [34,12,2,7,22,13,9], stack: 0 },
                                                                    { name: 'Output', data: [53,12,6,7,12,3,4], stack: 1 }]
                                                    });
        });

    </script>


    <script type="text/javascript">

        var $win = $(window)
                , $nav = $('.subnav')
                , navTop = $('.subnav').length && $('.subnav').offset().top - 40
                , isFixed = 1
        processScroll()

        $nav.on('click', function () {
            if (!isFixed) setTimeout(function () { $win.scrollTop($win.scrollTop() - 47) }, 10)
        })

        $win.on('scroll', processScroll)
        function processScroll() {
            var i, scrollTop = $win.scrollTop()
            if (scrollTop >= navTop && !isFixed) {
                isFixed = 1
                $nav.addClass('subnav-fixed')
            } else if (scrollTop <= navTop && isFixed) {
                isFixed = 0
                $nav.removeClass('subnav-fixed')
            }
        }

    </script>
{% endblock %}
